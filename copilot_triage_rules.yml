# triage rules for copilot / triage teams
# version: 1.2
# maintained_by: team-triage
# last_updated: 2025-11-24

---
# JSON Schema for validation
json_schema:
  $schema: "https://json-schema.org/draft-07/schema#"
  type: object
  properties:
    steps:
      type: array
      items:
        type: object
        # Add more detailed schema here if needed
    rules:
      type: array
      items:
        type: object
        # Add other top-level properties
  required: ["steps", "rules"]

# CI Validation
ci_validation:
  yamllint_config: ".yamllint.yml"  # Path to yamllint config
  schema_validation: true  # Enable JSON schema validation in CI
  pre_commit_hooks:
    - yamllint
    - jsonschema  # Assuming a tool for JSON schema validation

steps:
  # discovery
  - query: 'is:issue is:open -label:"Triaged" sort:created'
  # fetch candidate issues (issues only)
  - collect: "all fields"
  # capture issue body, labels, comments, project card, assignee, created_at

  # pre-check / enrichment (automatable)
  - check_required_fields:
    # if missing, add a 'needs-info' label and request details
    required:
      [
        "summary",
        "repro_steps",
        "expected_behavior",
        "actual_behavior",
        "size_estimate",
      ]
    validation:  # optional validation logic to enforce formats
      size_estimate:  # enforce allowed values for size_estimate
        allowed_values: ["xsmall", "small", "medium", "large", "epic"]
        # regex is anchored to avoid partial matches (exact-match only)
        regex: "^(xsmall|small|medium|large|epic)$"
        action_on_invalid: >

          add_label: needs-info; post_comment: invalid_size_estimate
  - detect_duplicates:
      enabled: true
      # Fuzzy similarity threshold 0.0-1.0, where higher values are stricter
      similarity_threshold: 0.78
      # Minimum token overlap to consider for fuzzy matches
      min_token_overlap: 0.25
      # Only search for duplicates reported within the last N days by default
      max_search_window_days: 365
      # Limit number of candidates to fetch per query to avoid heavy scans
      max_candidates: 25
      # Use a light-weight keyword prefilter before running expensive fuzzy
      # similarity computations (recommended for large repos)
      prefilter_keywords:
        ["crash", "exception", "PII", "authentication", "login"]
      # For extremely large repositories consider setting use_cache=true
      # and running dedupe in a background worker rather than inline.
      use_cache: true
      performance_notes: >
        For large repos, use background workers for fuzzy matching to avoid
        blocking triage. Cache similarity indexes and update incrementally.
  # scan for PII/sensitive data and take safe actions
  # (redact or route privately)
  # Uses heuristic pattern matching to detect common sensitive data formats
  - scan_for_pii:
    patterns:
      - '(?i)api[_-]?key\s*[:=]\s*\S+'
      # api_key or api-key: SECRET (e.g., api_key: sk-12345)
      - '(?i)secret\s*[:=]\s*\S+'
      # secret: SECRET (e.g., secret: mySecretValue)
      - '(?i)password\s*[:=]\s*\S+'
      # password: SECRET (e.g., password: pass123)
      - '(?i)ssn[:=]\s*\d{3}-?\d{2}-?\d{4}'
      # Social Security numbers (e.g., ssn: 123-45-6789)
      - '(?i)bearer\s+[A-Za-z0-9\-\._~\+/]+=*'
      # Bearer tokens (e.g., bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9)
      - "(?i)-----BEGIN PRIVATE KEY-----"
      # long key/pem blobs (e.g., -----BEGIN PRIVATE KEY-----...)
      # Common additional PII patterns to reduce false-negatives.
      # Note: some of these are broad (emails, phones) and can increase
      # false-positives; tune as needed for the project.
      - '(?i)[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}'
      # Phone numbers — supports country code, separators, parentheses
      - '(?i)(?:\+?\d{1,3}[-.\s]?)?(?:\(?\d{3}\)?|\d{3})[-.\s]?\d{3}[-.\s]?\d{4}'
      # Credit / debit card likeness (basic common BIN ranges)
      - '(?i)\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\b'
    prefilter_keywords:
      - "api_key"
      - "api-key"
      - "secret"
      - "password"
      - "ssn"
      - "bearer"
      - "private key"
      - "email"
      - "phone"
      - "credit card"
      - "card number"
    allowlists:
      email_domains:
        - "example.com"
        - "test.com"
        - "localhost"
        - "github.com"
        - "noreply.github.com"
      phone_prefixes: ["555", "123"]
      # Allow fake/test phone numbers
    action_on_detection:
      - redact_matches: true
      # mask or remove sensitive fragments from public body
      - add_label: "security"
      # mark as security-sensitive
      - move_to_private_queue: true
      # create/route to private intake for manual review
      - notify_channel: "security-oncall"
      # alert security team
    exempt_when_label_present: ["security", "manual-triage"]
    allow_human_override_label: "manual-triage"
    # Performance note: regex matching on very large issue or comment
    # bodies can be CPU intensive. Keep PII patterns focused and/or pre-
    # filter using simple keyword checks before running
    # heavyweight regexes for better throughput and fewer false-positives.
  - fetch_related_docs: true
  # search repo for docs & references to augment the issue

  # prioritization and routing
  - compute_severity:
    # use the severity table (see rules) to generate a proposed severity
    method: "heuristic"
    # heuristic method for severity based on issue content and impact
  - compute_priority:
  # priority may take severity + user impact + escalation tags
  - assign_triage_owner:
  # assign triage owner — Copilot bots own triage (see rules)

  # sanitize titles by removing embedded priority tags (e.g., [High Priority])

  # commit changes to issue and workflow system
  - check_execution_policy:  # check if on protected branch or dry-run
    set: "dry_run"  # boolean
    protected_branches: ["main"]
    on_dry_run:
      - add_label: "dry-run"
      - post_comment_template: "dry_run_notice"
    on_real_run:
      - continue: true
    note: >
      Automation must check this flag before making state-changing operations
      (labels, cards, moving).
  # sanitize titles by removing embedded priority tags (e.g., [High Priority])
  - sanitize_title_priority:
    description: >-
      After priority is computed and execution policy checked, remove human-
      entered priority tags embedded in issue titles to avoid duplication and
      keep titles clean. This is idempotent and logs the original title to the
      audit log.
    # Implementation note: this step should be idempotent. Bots must preserve
    # `original_title` as an audit field and avoid looping edits by checking
    # for the audit marker before writing changes.
    respect_execution_policy: true
    simulate_on_dry_run: true
    detection_patterns:
      - '(?i)\[Top Priority\]'
      - '(?i)\[High Priority\]'
      - '(?i)\[Low Priority\]'
      - '(?i)\[Medium Priority\]'
      - '(?i)\[P0\]'
      - '(?i)\[P1\]'
      - '(?i)\[P2\]'
      - '(?i)\[P3\]'
      - '(?i)\[Other\]'
    action:
      - if_detected:
          set_field: original_title
          replace_title: true
          new_title: "{{original_title|remove_detected_priority_tags}}"
          add_audit_fields: ["title_sanitized", "original_title"]
          on_dry_run:
            add_changed_field: "would_replace_title"
    skip_if_label_present:
      - "manual-triage"
      - "no-triage"
      - "security"
    allow_human_override_label: "manual-triage"
  - annotate_issue:
    # update issue with triage checklist, discovered docs,
    # and decision
    fields:
      ["severity", "priority", "triage_owner", "triage_notes", "references"]
  - add_labels:
      - "Triaged"
  # mark triaged issues; move to Backlog is gated
  # (see `move_to_backlog_gated` step)
  - post_comment_template: "triaged_backlog_notice"
  - move_card:
  # update associated project card & status column (if applicable)

  # gated move to backlog — only add Backlog when gate conditions are satisfied
  - move_to_backlog_gated:
    description: |-
      Add 'Backlog' label only when gating rules pass. Gates include:
      has size_estimate; feature-requests also require 'product-approved'.
      Respects dry-run and manual overrides.
    respect_execution_policy: true
    simulate_on_dry_run: true
    gate:
      # must have a quick size estimate for all issues before backlog
      - required_field: size_estimate
      # for feature requests require explicit product approval label
      - conditional:
          when_label_present: "feature-request"
          then_require_label: "product-approved"
    skip_if_label_present: ["manual-triage", "no-triage", "security"]
    allow_human_override_label: "manual-triage"
    actions:
      - on_pass:
          - add_label: "Backlog"
          - post_comment_template: "backlog_added_notice"
          - add_audit_fields: ["backlog_gate_passed", "backlog_gate_reasons"]
      - on_fail:
          # When the backlog gate fails we add an actionable flag
          # so maintainers can find and work items that need more info.
          - add_label: "needs-product-review"
          - add_label: "needs_work"
          - post_comment_template: "backlog_gate_blocked_notice"
          - add_audit_fields: ["backlog_gate_passed", "backlog_gate_reasons"]

  # escalation and follow-up
  - escalate_if:  # produce alert/ping when conditions met
      - condition: "severity==critical or label:security"
        action: |-
          notify@oncall,create_urgent_project_card

  # recording and metrics
  - log_triage_event:
    # append an audit entry with who/when/what
    path: "triage_log.json"
    include_execution_context: true

  # enforcement & housekeeping
  - reconcile_label_pairs:  # detect & reconcile triaged/backlog mismatch
    schedule: "daily"
    description: |-
      Find issues that have only one of Triaged/Backlog and remove both
      so they get reprocessed.
    apply_to: "issues"
    detection_condition: |-
      has_one_of_pair(Triaged,Backlog)
    action: "remove_labels"
    labels_to_remove: ["Triaged", "Backlog"]
    post_comment_template: "pair_mismatch_removed"

  # ensure 'Triaged' implies 'Backlog' (backfill/move-to-backlog)
  - triaged_to_backlog:
    description: |-
      Any issue labeled 'Triaged' should also have 'Backlog' — add if missing.
      This rule is idempotent and guarded to avoid flip-flops or label loops.
    apply_to: "issues"
    when_label_added: "Triaged"
    # Idempotency guards: only add Backlog if missing,
    # skip if manual-triage or security present
    if_missing_label: "Triaged"
    skip_if_any_present:
      - "manual-triage"
      - "security"
      - "no-triage"
    # Respect recent human edits — skip automation if labels were changed
    # by a human within grace_period_hours
    skip_on_recent_human_action: true
    grace_period_hours: 24
    add_label: "Backlog"
    post_comment_template: "triaged_backlog_notice"
    # Log an audit-friendly event key so automation and humans can track
    # what happened
    audit_event: |-
      triaged_to_backlog:added_backlog

  - backlog_to_triaged:
    description: |-
      Any issue labeled 'Backlog' should also have 'Triaged' — add if missing.
      Idempotent and guarded to avoid label flip-flops.
    apply_to: "issues"
    when_label_added: "Backlog"
    # Only add Triaged when missing and not explicitly skipped by humans
    # or security
    if_missing_label: "Triaged"
    skip_if_any_present:
      - "manual-triage"
      - "security"
      - "no-triage"
    skip_on_recent_human_action: true
    grace_period_hours: 24
    add_label: "Triaged"
    post_comment_template: "label_added"
    audit_event: |-
      backlog_to_triaged:added_triaged

  # when issues are moved (labels added) showing the item is now being
  # worked on, convert Backlog -> Ready To Work
  - backlog_to_inprogress:
    description: |-
      When an issue receives 'In Progress' while also in 'Backlog',
      remove 'Backlog' and add 'Ready To Work' to reflect readiness for
      execution.
    apply_to: "issues"
    when_label_added: "In Progress"
    requires_existing_label: "Backlog"
    actions:
      - remove_label: "Backlog"
      - add_label: "Ready To Work"
    post_comment_template: "backlog_to_ready_notice"

  # deterministic triage completion conditions
  - triaged_if:
      - required_fields_present:
          - "summary"
          - "repro_steps"
          - "expected_behavior"
          - "actual_behavior"
          - "size_estimate"
      - triage_owner_assigned: true
      - severity_assigned: true

rules:
  # primary filters
  - process_only: |-
      type == issue and not label == "Triaged" and state == open

  # label rules and expectations
  - label_policy:
    triaged_labels: ["Triaged", "Backlog"]
    preferred_case: true
    label_normalization:
      "needs triage": "Needs Triage"
      "Needs triage": "Needs Triage"
      "triaged": "Triaged"
      "backlog": "Backlog"
      "ready to work": "Ready To Work"
      "Ready to work": "Ready To Work"
      "in progress": "In Progress"
      "In Progress": "In Progress"
      "in review": "In Review"
      "In review": "In Review"
      "done": "Done"
    scan_frequency: "daily"
    # labels to skip for auto-labeling / reconciliation — these often
    # require special handling
    excluded_labels:
      - "security"
      - "legal"
      - "no-triage"
      - "auto-generated"
      - "wontfix"
      - "duplicate"
    # authors whose issues should not be auto-labeled
    # (typical bots / automation accounts)
    excluded_authors:
      - "dependabot[bot]"
      - "github-actions[bot]"
      - "renovate[bot]"
      - "automation-bot"
    # skip auto-labeling for issues created by bots/automation
    skip_for_automated_issues: true
    # if a human explicitly marks manual-triage, do not auto-reconcile labels
    manual_override_label: "manual-triage"
    manual_override_semantics:
      who_can_override:
        - "team-triage"
        - "maintainers"
        - "admins"   # GitHub teams or users with override permission
      audit_overrides: true  # Log manual overrides in triage_log.json
      override_actions:
        [
          "skip_automation",
          "force_label_add",
          "force_label_remove",
        ]   # Allowed override actions
    preservation_rules:
      # guidance to avoid accidental removal
      - |-
          Do not remove Triaged or Backlog without explicit triage update.
    pair_enforcement:
      description: |-
        Triaged and Backlog must exist together on issues. Triaged prevents
        the bot from reworking the issue; Backlog triggers downstream
        workflows.
      pair: ["Triaged", "Backlog"]
      on_mismatch: "remove_both"  # remove both labels when mismatch detected
      # safety: if one of the pair was modified recently (less than
      # grace_period_hours)
      # by a user,
      # the system will skip automatic removal and notify maintainers instead
      # of making changes.
      grace_period_hours: 24
      skip_on_recent_human_action: true
      notify_on_skip: true  # notify triage channel if skip

  # title sanitization (remove embedded priority tags after priority
  # computed)
  - title_priority_cleanup:
    description: >
      Remove explicit priority tags from titles after priority is
      computed during triage.
      Bot logs original title and why it changed the title.
    detection_patterns:
      - '(?i)\[Top Priority\]'
      - '(?i)\[High Priority\]'
      - '(?i)\[Medium Priority\]'
      - '(?i)\[Low Priority\]'
      - '(?i)\[P0\]'
      - '(?i)\[P1\]'
      - '(?i)\[P2\]'
      - '(?i)\[P3\]'
      - '(?i)\[Other\]'
    action:
      - if_detected:
          - set_field: original_title
          - sanitize_title: true
          - add_audit_fields: ["title_sanitized", "original_title"]
    skip_if_label_present: ["manual-triage", "no-triage", "security"]
    idempotent: true
    human_override_label: "manual-triage"

  # required metadata before marking Triaged
  - required_issue_fields:
    summary: "short one-line explanation"
    repro_steps: "how to reproduce (or sample data)"
    expected_behavior: "what should happen"
    actual_behavior: |-
      what happens instead (include logs/traceback if available)
    size_estimate: |
      "quick size estimate used for prioritization and metrics.
       Allowed values: xsmall | small | medium | large | epic.
       Keep estimates conservative; one-word value preferred."

  # severity definitions (recommended table)
  - severity_levels:
    critical: >
      Complete loss of service or data corruption affecting many users;
      security exploit in progress
    high: >
      Major feature broken for many users;
      blocking revenue or critical workflows
    medium: >
      Feature missing or broken for a subset of users,
      or minor but repeatable data loss
    low: "Small UI bug, typo, or low impact issue"

  # prioritization guidance
  - prioritization_factors:
      [
        "severity",
        "user_impact",
        "customer_escrow",
        "number_of_reports",
        "time_sensitive",
      ]

  # concurrency and ownership
  - triage_ownership:
    concurrent_work: >
      Allowed if issues do not touch the same files/owners or project cards;
      otherwise acquire lock
    # Copilot bots always own triage across the project
    default_owner: "copilot-bot"
    keep_audit_comment: true

  # triage bot behavior
  - triage_bot_settings:
    skip_processing_if_label_present: ["Triaged"]
    skip_if_triaged_and_later_stage_present:
      ["Ready To Work", "In Progress", "In Review", "Done"]
    reason_for_skip: >
      Triaged prevents triage bot from reworking the issue;
      when Triaged appears alongside downstream workflow labels the issue is
      beyond triage and should be ignored by triage operations
    # when the bot adds/removes labels it should post a short explanatory
    # comment
    auto_label_comments: true
    comment_on_label_add_template: "label_added"
    comment_on_label_remove_template: "label_removed"
    # dry-run behavior for non-protected branches
    protected_branches: ["main"]
    mark_dry_run_on_non_protected_branch: true
    dry_run_label: "dry-run"
    dry_run_comment_template: "dry_run_notice"

  # automation & enforcement
  - automation_recommendations:
      # use existing templates in `.github/ISSUE_TEMPLATE/`
      # (work-tracking, bug_report, etc.)
      - use_issue_templates: true
      - enforce_minimum_fields_with_bot: true
      # per request: ignore automatic GH Action for now
      - add_github_action_to_auto_label_docs: "deferred"
      # recommend adding a GH Action to auto-add 'Needs Triage' labels on issue
      # creation
      - auto_label_new_issues: true
      # recommend nightly job to add missing intake labels and record fixes
      - scheduled_label_audit: true

  # edge cases & special categories
  - security: >
      Close coordination with security team;
      don't post sensitive details in public issue comments.
      Use the security contact or private channel.
  - legal: "Tag `legal-review` and escalate to product/legal owner"

  # error handling for step failures
  - error_handling:
    description: "Handle failures in triage steps to ensure robustness."
    # General retry defaults (used when step-specific settings are not
    # provided)
    retry_logic:
      max_retries: 3
      backoff_seconds: 60  # exponential backoff
      on_failure: "log_error; notify_triage_channel"
    # Per-step retry semantics: treat API/network failures more leniently
    # (retries + jitter) and treat parsing/validation problems as fast
    # failures to avoid retry loops.
    per_step_retry:
      api_failure:
        max_retries: 5
        backoff_seconds: 30
        jitter: true
        retry_on: ["timeout", "http5xx", "rate_limit"]
      parsing_error:
        max_retries: 1
        backoff_seconds: 10
        retry_on: ["transient_parser_error"]
      auth_or_permission_error:
        max_retries: 0
        backoff_seconds: 0
        retry_on: []
    fallback_notifications:
      channels: ["triage-oncall"]
      template: "error_occurred"

  # metrics and monitoring for data-driven improvements
  - metrics_and_monitoring:
    description: "Track triage metrics for dashboards and alerts."
    metrics:
      - triage_completion_rate: "Percentage of issues triaged within SLA"
      - average_triage_time: "Average time from issue creation to triage"
      - average_time_to_assign_owner: >
          Average time from triage start to assignment of triage owner
      - median_time_to_triage: >
          Median time from creation to triage (less sensitive to outliers)
      - pii_detection_rate: "Rate of PII detections"
      - error_rate: "Percentage of triage runs with errors"
      - pii_events: "Count of PII detection events"
      - dry_runs: "Count of dry-run triage executions"
      - triaged_count: "Total issues triaged"
      - backlog_gate_failures: "Count of backlog gate failures"
    retention_guidance: >
      Retain metrics data for 1 year, triage logs for 2 years.
      Archive older data to cold storage.
    dashboard_integration:
      tool: "prometheus"  # or grafana, etc.
      alerts:
        - condition: "triage_completion_rate < 90%"
          action: "notify_triage_team"

  # helpful conventions
  - triage_checklist:
      - >-
        Verify reproducibility / request reproduction info if missing
      - >-
        Record a quick size estimate (xsmall|small|medium|large|epic)
      - "Link any relevant docs or design decisions"
      - "Classify severity & priority and explain why"
      - "If duplicate, close as duplicate and link canonical issue"
      - "Assign an owner or milestone"
      - >
          Remove 'Needs Triage' only when the issue is triaged;
          add 'Triaged' and 'Backlog' labels when appropriate

  # quick size estimate rules: enforce allowed values and why they are
  # required
  - quick_size_estimates:
    allowed_values: ["xsmall", "small", "medium", "large", "epic"]
    enforcement:
      required_for_triage: true
      bot_action_if_missing: >
        add_label: needs-info; post_comment: request_more_info
      human_override_label: "manual-triage"
    usage_notes: >
      Quick estimate should be conservative;
      used for prioritization and metrics.

  # label mappings and deterministic classification
  - label_mappings:
    label_to_severity:
      "severity/critical": "critical"
      "severity/high": "high"
      "severity/medium": "medium"
      "severity/low": "low"
    label_to_priority:
      "priority/p0": "p0"
      "priority/p1": "p1"
      "priority/p2": "p2"
      "priority/p3": "p3"

  # service-level targets for triage (SLA)
  - sla:
    description: >
      Target response / initial triage times by severity
      (working hours unless otherwise noted).
    targets:
      critical: "1 hour"
      high: "24 hours"
      medium: "72 hours"
      low: "7 days"

  # structured triage event / audit schema (triage_log.json)
  - triage_audit_schema:
    description: >
      Canonical schema for each triage event appended to triage_log.json.
      This enables dashboards and auditability.
    version: "1.2"  # schema version for future extensions
    fields:
      - issue_number: {type: int, description: "GitHub issue number"}
      - triage_owner:
          type: string
          description: "Bot or user who performed triage"
      - event_type:
          type: string
          description: |-
            e.g., 'initial_triage','update','escalation','duplicate'
      - timestamp:
          type: rfc3339
          description: "ISO 8601 timestamp of the event"
      - severity:
          type: string
          description: >
            Severity level (critical, high, medium, low)
      - priority:
          type: string
          description: "Priority level (p0, p1, p2, p3)"
      - size_estimate:
          type: string
          description: >
            Quick size estimate (xsmall, small, medium, large, epic)
      - pii_detected:
          type: bool
          description: "Whether PII was detected in the issue"
      - redacted_fields:
          type: list
          description: "Fields that were redacted"
      - redaction_actions:
          type: list
          description: "Actions taken for redaction"
      - dry_run:
          type: bool
          description: "Whether the triage was a dry run"
      - execution_branch:
          type: string
          description: "Git branch where triage ran"
      - backlog_gate_passed:
          {type: bool, description: "Whether backlog gating passed"}
      - backlog_gate_reasons:
          {type: list, description: "Reasons for backlog gate outcome"}
      - title_sanitized:
          {type: bool, description: "Whether the title was sanitized"}
      - original_title:
          {type: string, description: "Original title before sanitization"}
      - changed_fields:
          {type: list, description: "Fields changed during triage"}
      - notes: {type: string, description: "Additional triage notes"}
      - references:
          {type: list, description: "Links to docs or related issues"}
      - override_by:
          type: string
          description: "User or group who applied manual override"
      - override_reason:
          {type: string, description: "Reason for manual override"}
      - override_timestamp:
          {type: rfc3339, description: "Timestamp of manual override"}
    example: |
      {
        "issue_number": 123,
        "triage_owner": "copilot-bot",
        "event_type": "initial_triage",
        "timestamp": "2025-11-24T19:32:00Z",
        "severity": "high",
        "priority": "p1",
        "size_estimate": "small",
        "pii_detected": true,
        "redacted_fields": ["issue_body"],
        "redaction_actions": ["redact", "move_to_private_intake"],
        "dry_run": false,
        "execution_branch": "main",
        "title_sanitized": true,
        "original_title": "[Top Priority] README placeholders.",
        "changed_fields": ["severity","triage_owner","labels"],
        "notes": "Confirmed reproducible",
        "references": ["docs/memory-model.md","PR#456"]
      }

# Centralized Secrets and Environment Configuration
  - secrets_config:
    secure_intake_url: "${SECURE_INTAKE_URL}"  # Env var for secure intake URL
    bot_comment_templates:
      # Templates can reference secrets
      secure_intake_instructions: |
        This issue contains sensitive data. To help us investigate securely,
        please use the secure intake form at ${SECURE_INTAKE_URL} or
        contact `security-oncall` directly. Do not paste secrets or personal
        data in public comments.
    request_more_info: |
      Thanks for filing this issue — I'm the triage bot and need a bit more
      info to proceed.
      Please update the issue with steps to reproduce and any relevant logs
      (see `.github/ISSUE_TEMPLATE/bug_report.md`).

    marked_duplicate: |
      This appears to be a duplicate of #{canonical_issue} — linking and
      closing this one as duplicate.
      If you believe the issue is different, please explain how it differs
      and reopen.

    triaged_summary: |
      Triage summary: severity = {severity}, priority = {priority}, owner =
      {triage_owner}. Links/refs: {references}.

    triaged_backlog_notice: |
      This issue has been marked as `Triaged` and placed into the `Backlog`.
      Note: `Triaged` prevents the triage bot from reworking the issue;
      `Backlog` is used to trigger downstream work planning. If this is
      incorrect, please remove or update these labels.

    dry_run_notice: |
      Note: this triage run is a dry-run because the automation is not
      running on a protected branch. I did not change issue labels or move
      project cards — these actions are simulated. To allow real changes,
      run on the `main` branch or add the `manual-triage` override.

    backlog_added_notice: |
      This issue passed backlog gating and has been placed into the `Backlog`
      for planning.
      If the move is incorrect, remove the label or add `manual-triage` to
      prevent automated changes.

    backlog_gate_blocked_notice: |
      This issue cannot be moved into `Backlog` yet because it did not meet
      our gating requirements.
      Requirements: a quick `size_estimate`, and for feature requests the
      `product-approved` label.
      Next steps: add the missing information or contact the product owner to
      approve (label `product-approved`).
      The automation has added the `needs_work` label so this item will be
      included in the grooming queue for follow-up.

    title_cleaned_notice: |
      I removed priority tags from the issue title (e.g. [High Priority]) to
      keep titles clean and avoid duplicate priority markers. The priority has
      been recorded in the issue metadata. If this edit is incorrect, you can
      revert the change or add the `manual-triage` label to prevent automated
      edits.

    redaction_notice: |
      The content you provided appears to contain sensitive information and has
      been redacted from public view to protect your data.
      If you need to share additional details, please use our secure intake
      channel (see `secure_intake_instructions`) or contact the security team
      privately.

    secure_intake_instructions: |
      This issue contains sensitive data. To help us investigate securely,
      please use the secure intake form at <SECURE_INTAKE_URL> or contact
      `security-oncall` directly. Do not paste secrets or personal data in
      public comments.

    label_added: |
      I added the `{label}` label to this issue as part of the triage
      workflow.
      Reason: {reason}

    label_removed: |
      I removed the `{label}` label from this issue as part of the triage
      workflow.
      Reason: {reason}

    pair_mismatch_removed: |
      I removed both `Triaged` and `Backlog` because their presence was
      out-of-sync.
      Reason: both labels must exist together — removing both so this issue
      can be reprocessed.

    backlog_to_ready_notice: |
      The `Backlog` label was removed and replaced with `Ready To Work`
      because this issue moved into work (In Progress).
      Reason: `Ready To Work` indicates the issue is prepared for active
      execution by the team.

    escalation_notice: |
      This issue has been escalated based on severity/labels. Notifying:
      {channels}.

  # duplicate detection & canonical issue policy
  - duplicates:
    # bots should use fuzzy matching
    detection: "heuristic + title/body similarity + reported-by/time-range"
    # Notes for implementers: duplicate detection may be expensive on large
    # repositories. Use the `detect_duplicates` prefilter keywords and
    # `max_search_window_days` settings to constrain work. Consider background
    # workers or cached similarity indexes for scale.
    policy: |
      - If duplicates are detected, link to the canonical issue and leave a
        short comment
      - Close the duplicate with the reason 'Duplicate - linked to
        #<canonical_issue>'
      - If two issues appear similar but different (e.g., different root cause),
        the bot will NOT close and will ask for clarification
    canonical_linking: |
      Prefer the earliest confirmed reproducible issue as canonical.
      Document why canonical was chosen in triage_log.json.

  # bot permissions, privacy, and security handling
  - bot_permissions:
    owner: "copilot-bot"
    allowed_actions:
      - "read_issues"
      - "post_comments"
      - "add_labels"
      - "update_issue_body_with_triage_fields"
      - "append_triage_log"
      - "move_project_cards"
      - "add_labels"
      - "remove_labels"
    forbidden_actions:
      - "post_sensitive_data"  # e.g., full stack traces with secrets, PII
      - "auto_close_security_issues_without_review"
    # automated PII handling is allowed and required for data hygiene
    allowed_pii_actions:
      - redact_issue_body_matches: true
      - append_redaction_note: true
      - move_to_private_queue: true
    privacy_rules: |
      - Do not post or echo PII (names, emails, phone numbers, auth tokens)
        in public issue comments.
      - If issue content contains PII or secrets, redaction must be applied
        (mask or instruct to remove) and tag `security`.
      - For security-tagged issues, the bot will escalate to security private
        channel and avoid adding details in public issue comments.
    security_escalation:
      workflow: |
        If label:security or severity==critical then create private alert and
        notify security-oncall.
        Do not post sensitive details in public comments.

  # machine-enforced PII handling rules
  - pii_handling:
    description: |
      Machine-first PII detection, automatic redaction,
      and private escalation workflow.
      Bots will redact, label, and route sensitive content,
      while allowing manual overrides.
    detect_patterns:  # default patterns used by scan_for_pii step
      - "api[_-]?key"
      - "secret"
      - "password"
      - "ssn"
      - "bearer token|bearer"
      - "-----BEGIN PRIVATE KEY-----"
    actions_on_detection:
      # redact matching fragments in public issue text and replace with
      # placeholder
      - redact:
          placeholder: "[REDACTED — contact security for secure intake]"
          redact_scope: ["issue_body", "comments"]
      - add_label: "security"
      - move_to_private_intake: true
      - notify: "security-oncall"
      - append_audit:  # include redaction event in triage log
          fields: ["pii_detected", "redacted_fields", "redaction_actions"]
    exempt_if_any_label_present: ["manual-triage", "security", "no-triage"]
    human_override_label: "manual-triage"
    grace_period_hours: 24

  # safe-handling examples
  - security_examples:
      - example_incoming: "User pasted a stack trace containing credentials"
        bot_action: |
          Respond asking to redact credentials and moved issue to private
          security queue;
          notify security-oncall
      - example_incoming: "Bug report contains PII in reproduction steps"
        bot_action: |
          Request anonymization in public, offer a secure private intake channel
          for sensitive reproduction data

  # optional notes for maintainers
  - notes: |-
      This file defines a recommended triage workflow. Small projects may choose
      stricter or looser conventions. Recommended automation: a GitHub Action or
      bot
      that enforces required fields and appends audit entries to
      `triage_log.json`.
      Auto-labeling via GitHub Actions is deferred per current
      direction.
  - safety_guarantees: |
      Automation must be idempotent and avoid label flip-flops. For example,
      `triaged_to_backlog` and `backlog_to_triaged` only add labels
      when missing,
      skip if `manual-triage` or security/no-triage tags are present,
      and respect
      recent human edits (grace_period_hours = 24) to avoid undoing
      user changes.

  # Idempotency Checks and Examples
  - idempotency_checks:
    description: |
      Ensure operations are idempotent to prevent repeated executions from
      causing issues.
    examples:
      - |
        Check if label already exists before adding (e.g., if 'Triaged' in
        issue.labels, skip add)
      - "Use audit logs to detect previous runs and skip if already processed"
      - "For title sanitization, check for audit marker before editing"
      - |
        Avoid flip-flops: if adding 'Backlog' when 'Triaged' is added,
        ensure not to remove it later unless conditions change
    implementation: |
      Each step should include a check: if already_applied(event),
      skip

  # execution / branch policy — enforce dry-run on non-main branches
  - execution_policy:
    description: |-
      Avoid performing real repository modifications unless running on the
      protected branch(es). All other branches run in dry-run mode where the
      bot reports actions but does not change state.
    protected_branches: ["main"]
    default_behavior: "dry_run"  # behavior applied unless current branch
    # is in protected_branches
    mutate_branches: ["main"]
    dry_run_marker_label: "dry-run"  # label added to issues when the
    # run was simulated
    dry_run_comment_template: "dry_run_notice"
    # Safety: enforce that any step which would change labels/move cards/
    # remove labels/add labels/move cards
    # must check execution_policy before performing stateful changes.

  # project management — configure project board integration
  - project_management:
    description: |-
      Configure GitHub Projects integration for automatic card movement
      during triage. When issues are triaged and moved to backlog,
      also move the associated project card to the Backlog column.
    enabled: true
    project_id: 1234567  # Replace with actual project ID
    columns:
      Backlog: 8765432  # Replace with actual column ID for Backlog
    # Note: Project IDs and column IDs can be found via GitHub API:
    # GET /repos/{owner}/{repo}/projects
    # GET /projects/{project_id}/columns

  # guidance for bots to check the execution policy before state-changing ops
  - execution_policy_checks:
    description: |
      Template guidance for automation: how to query the execution
      policy and respect dry-run vs real-run before making label or card
      changes. Bots should consult the checked flag produced by the
      check_execution_policy step (runtime variable `dry_run`) and avoid
      performing any state-changing operations when true.
    example_snippet: |
      # pseudocode — evaluate the runtime flag set by the pipeline
      if runtime.get('dry_run', True):
        # do not change labels/cards — log or post a dry-run comment
        log('dry-run: simulated change — skipping label modification')
      else:
        # safe to perform state-changing operations
        add_label(issue, 'Triaged')
    # bots should always check protected branch list & the runtime `dry_run`
    checks_required: ["protected_branches", "dry_run", "execution_branch"]

  # Test Vectors for Unit Tests
  - test_vectors:
    pii_detection:
      positive:
        - input: "My api_key is sk-1234567890abcdef"
          expected: true
        - input: "Password: mySecret123"
          expected: true
        - input: "Email: user@example.com"
          expected: false  # allowlisted
        - input: "Phone: 555-123-4567"
          expected: false  # allowlisted prefix
      negative:
        - input: "This is a normal sentence."
          expected: false
    duplicate_detection:
      positive:
        - issue1: "App crashes on startup"
          issue2: "Application crashes when starting"
          expected: true
      negative:
        - issue1: "Feature request for dark mode"
          issue2: "Bug: login fails"
          expected: false
    execution_policy:
      dry_run_cases:
        - branch: "main"
          expected_dry_run: false
        - branch: "feature-branch"
          expected_dry_run: true

  # repository templates (existing)
  - templates:
      - path: ".github/ISSUE_TEMPLATE/work-tracking.md"
        purpose: "work-tracking, heavy-weight issue intake"
      - path: ".github/ISSUE_TEMPLATE/bug_report.md"
        purpose: "bug reports — include reproduction, logs, and screenshots"
      - path: ".github/ISSUE_TEMPLATE/feature_request.md"
        purpose: "feature requests — include goals and acceptance criteria"
      - path: ".github/ISSUE_TEMPLATE/task.md"
        purpose: "small tasks and chores"

  # Canonical Label Definitions
  - canonical_labels:
    # List of all labels with definitions and gating criteria
    - name: "Backlog"
      definition: "Issues that have been triaged and meet gating criteria for inclusion in the backlog queue."
      gating_criteria: "Must have size_estimate; if feature-request, must have product-approved; not security or no-triage; respects execution policy and dry-run."
    - name: "Triaged"
      definition: "Issue has undergone initial triage, including severity/priority assignment and required field checks."
      gating_criteria: "Applied after triage steps complete; removed if pair mismatch with Backlog."
    - name: "needs-info"
      definition: "Issue is missing required fields or information; reporter must provide more details before triage can proceed."
      gating_criteria: "Added if required fields (e.g., summary, size_estimate) are missing; removed after info provided."
    - name: "security"
      definition: "Issue involves security concerns, PII, or sensitive data; requires special handling and escalation."
      gating_criteria: "Added if PII detected or manually flagged; exempts from some automations."
    - name: "dry-run"
      definition: "Triage run is simulated on non-protected branches; no real changes made to issues."
      gating_criteria: "Added automatically on branches not in protected_branches (e.g., not main); removed on real runs."
    - name: "feature-request"
      definition: "Request for new features or enhancements, subject to product approval gating."
      gating_criteria: "User-applied or detected; requires product-approved for Backlog; no auto-add."
    - name: "product-approved"
      definition: "Feature request has been approved by product team for inclusion in backlog."
      gating_criteria: "Must be present for feature-request to enter Backlog; added manually by product owners."
    - name: "manual-triage"
      definition: "Human override to skip or modify automated triage for this issue."
      gating_criteria: "Respects human actions; prevents auto-changes within grace_period_hours (24 hours)."
    - name: "no-triage"
      definition: "Issue should not be triaged; exempt from automation."
      gating_criteria: "Exempts from all triage steps; added manually or for bots/automation issues."
    - name: "needs-product-review"
      definition: "Feature request lacks product approval; requires review before Backlog."
      gating_criteria: "Added if feature-request without product-approved; removed after approval."
    - name: "needs_work"
      definition: "Issue does not meet Backlog gating; needs fixes before inclusion."
      gating_criteria: "Added if gating fails (e.g., missing size_estimate); removed after fixes."
    - name: "Ready To Work"
      definition: "Issue is in Backlog and has been picked up for active work."
      gating_criteria: "Added when In Progress applied to Backlog issue; replaces Backlog label."
    - name: "In Progress"
      definition: "Work on the issue has started; team is actively working on it."
      gating_criteria: "User-applied; triggers Ready To Work if Backlog present."
    - name: "In Review"
      definition: "Issue is under review (e.g., code review, testing)."
      gating_criteria: "User-applied; indicates post-work phase."
    - name: "Done"
      definition: "Issue has been completed and resolved."
      gating_criteria: "User-applied; final state in workflow."
    - name: "duplicate"
      definition: "Issue is a duplicate of another; should be closed and linked to canonical issue."
      gating_criteria: "Detected via fuzzy matching; added manually or auto if high similarity."
    - name: "legal-review"
      definition: "Issue requires legal review; tag for escalation to legal/product owners."
      gating_criteria: "Added for legal-related issues; no auto-add."
    - name: "severity/critical"
      definition: "Critical severity: complete loss of service or data, security exploit in progress."
      gating_criteria: "Mapped from heuristics or user labels; used for priority and escalation."
    - name: "severity/high"
      definition: "High severity: major feature broken for many users, blocking workflows."
      gating_criteria: "Mapped from heuristics or user labels; used for priority and escalation."
    - name: "severity/medium"
      definition: "Medium severity: feature broken for subset of users, minor data loss."
      gating_criteria: "Mapped from heuristics or user labels; used for priority and escalation."
    - name: "severity/low"
      definition: "Low severity: small UI bug, typo, low impact issue."
      gating_criteria: "Mapped from heuristics or user labels; used for priority and escalation."
    - name: "priority/p0"
      definition: "Priority 0: production outage, must-fix immediately."
      gating_criteria: "Mapped from severity or user labels; used for prioritization."
    - name: "priority/p1"
      definition: "Priority 1: high priority, fix soon."
      gating_criteria: "Mapped from severity or user labels; used for prioritization."
    - name: "priority/p2"
      definition: "Priority 2: medium priority, backlog item."
      gating_criteria: "Mapped from severity or user labels; used for prioritization."
    - name: "priority/p3"
      definition: "Priority 3: low priority, nice-to-have."
      gating_criteria: "Mapped from severity or user labels; used for prioritization."
    # Standard GitHub labels (definitions per GitHub defaults; no special gating)
    - name: "bug"
      definition: "Something isn't working"
      gating_criteria: "User-applied; no automation"
    - name: "chore"
      definition: "Maintenance / chores"
      gating_criteria: "User-applied; no automation"
    - name: "dependencies"
      definition: "Pull requests that update a dependency file"
      gating_criteria: "Auto-applied by GitHub; no triage gating"
    - name: "documentation"
      definition: "Improvements or additions to documentation"
      gating_criteria: "User-applied; no automation"
    - name: "enhancement"
      definition: "New feature or request"
      gating_criteria: "User-applied; no automation"
    - name: "github_actions"
      definition: "Pull requests that update GitHub Actions code"
      gating_criteria: "Auto-applied by GitHub; no triage gating"
    - name: "good first issue"
      definition: "Good for newcomers"
      gating_criteria: "User-applied; no automation"
    - name: "help wanted"
      definition: "Extra attention is needed"
      gating_criteria: "User-applied; no automation"
    - name: "invalid"
      definition: "This doesn't seem right"
      gating_criteria: "User-applied; no automation"
    - name: "question"
      definition: "Further information is requested"
      gating_criteria: "User-applied; no automation"
    - name: "wontfix"
      definition: "This will not be worked on"
      gating_criteria: "User-applied; no automation"
    - name: "needs-triage"
      definition: "Needs triage"
      gating_criteria: "Auto-added on new issues; removed after Triaged"
    - name: "P0"
      definition: "Priority 0 — production outage / must-fix"
      gating_criteria: "User-applied or mapped; alternative to priority/p0"
    - name: "P1"
      definition: "Priority 1 — high priority"
      gating_criteria: "User-applied or mapped; alternative to priority/p1"
    - name: "P2"
      definition: "Priority 2 — medium priority"
      gating_criteria: "User-applied or mapped; alternative to priority/p2"
    - name: "P3"
      definition: "Priority 3 — low priority/backlog"
      gating_criteria: "User-applied or mapped; alternative to priority/p3"
    - name: "python"
      definition: "Pull requests that update python code"
      gating_criteria: "Auto-applied by GitHub; no triage gating"

  # Changelog
  - changelog:
    policy: |
      Bump schema version on breaking changes or major feature additions.
      Update last_updated date on any change.
      Maintain backward compatibility where possible.
    entries:
      - version: "1.2"
        date: "2025-11-24"
        changes:
          - |
            Added machine-readable JSON schema and CI validation
            (yamllint, jsonschema)
          - |
            Tightened PII regexes with pre-filters and allowlists for
            low-risk domains
          - |
            Added explicit test vectors for PII detection, duplicate detection,
            and execution policy
          - |
            Made manual override semantics explicit with who_can_override and
            audit fields
          - |
            Added runtime telemetry counters (PII events, dry_runs, etc.) and
            retention guidance
          - |
            Improved performance notes with caching and background worker
            recommendations
          - "Centralized secure intake URL into environment variables"
          - |
            Added idempotency check section and examples to avoid label
            flip-flops
          - "Added developer guidance section"

  # Developer Guidance
  - developer_guidance:
    testing_locally: |
      Use venv for Python dependencies. Run unit tests with pytest.
      Validate YAML with yamllint --config .yamllint.yml
      copilot_triage_rules.yml
    linters: "yamllint for YAML, jsonschema for JSON schema validation"
    how_to_test: |-
      1. Set up venv: python -m venv triage_env &&
      source triage_env/bin/activate.
      2. Install deps: pip install -r requirements.txt.
      3. Run tests: pytest tests/.
      4. Validate schema: jsonschema -i copilot_triage_rules.yml json_schema
