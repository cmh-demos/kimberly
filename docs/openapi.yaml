openapi: 3.0.3
info:
  title: Kimberly API
  version: 0.1.0
  description: OpenAPI spec for Kimberly personal AI assistant (MVP surface).
servers:
  - url: https://api.kimberly.local/v1
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    SignupRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [email, password]
    AuthResponse:
      type: object
      properties:
        token:
          type: string
    TokenResponse:
      type: object
      properties:
        token:
          type: string
        expires_in:
          type: integer
          description: seconds until token expires
    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: integer
    ChatMessage:
      type: object
      properties:
        id:
          type: string
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        created_at:
          type: string
          format: date-time
    ChatResponse:
      type: object
      properties:
        conversation_id:
          type: string
        message:
          $ref: '#/components/schemas/ChatMessage'
        usage:
          type: object
          properties:
            prompt_tokens:
              type: integer
            completion_tokens:
              type: integer
            total_tokens:
              type: integer
    MemoryItem:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [short-term, long-term, permanent]
        content:
          type: string
        size_bytes:
          type: integer
        metadata:
          type: object
        score:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
    MemoryListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MemoryItem'
        page:
          type: integer
        per_page:
          type: integer
        total:
          type: integer
    Agent:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [idle, running, failed, completed]
        last_run:
          type: string
          format: date-time
    AgentTaskResponse:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
        result:
          type: object
    ChatRequest:
      type: object
      properties:
        message:
          type: string
        context_id:
          type: string
      required: [message]
    ChatResponse:
      type: object
      properties:
        reply:
          type: string
        confidence:
          type: number
          format: float
    MemoryItem:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [short-term, long-term, permanent]
        content:
          type: string
        created_at:
          type: string
          format: date-time
    AgentInvocation:
      type: object
      properties:
        task:
          type: string
        params:
          type: object

    MemoryQueryRequest:
      type: object
      properties:
        query:
          type: string
        type:
          type: string
          enum: [short-term, long-term, permanent, any]
        top_k:
          type: integer
          default: 5
        filters:
          type: object
      required: [query]

    MemoryQueryResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/MemoryItem'

    MeditateResponse:
      type: object
      properties:
        status:
          type: string
        processed:
          type: integer
        pruned:
          type: integer
        archived:
          type: integer

    MemoryMetrics:
      type: object
      properties:
        quota:
          type: object
        usage:
          type: object
        last_meditation:
          type: string
paths:
  /signup:
    post:
      summary: Create a user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      requestBody:
        description: User sign-up payload
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
            examples:
              signup-example:
                value:
                  email: "alice@example.com"
                  password: "s3curePass!"
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /login:
    post:
      summary: Authenticate user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      requestBody:
        description: User login
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
            examples:
              login-example:
                value:
                  email: "alice@example.com"
                  password: "s3curePass!"
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  uptime_seconds:
                    type: integer
  /chat:
    post:
      summary: Send a chat message to Kimberly
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      requestBody:
        description: Chat message
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple-chat:
                value:
                  message: "What's on my schedule today?"
      responses:
        '200':
          description: Chat response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                simple:
                  value:
                    conversation_id: "conv_123"
                    message:
                      id: "msg_456"
                      role: assistant
                      content: "Hello â€” how can I help today?"
                      created_at: "2025-11-22T19:00:00Z"
                    usage:
                      prompt_tokens: 4
                      completion_tokens: 12
                      total_tokens: 16
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory:
    get:
      summary: List memory items
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Memory list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryListResponse'
              examples:
                sample-memory-list:
                  value:
                    items:
                      - id: "mem_1"
                        type: short-term
                        content: "Met Mike at the cafe"
                        size_bytes: 120
                        score: 0.8
                        created_at: "2025-11-22T10:00:00Z"
                    page: 1
                    per_page: 20
                    total: 1
    post:
      summary: Add a memory item
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [short-term, long-term, permanent]
                content:
                  type: string
              required: [type, content]
      requestBody:
        description: Memory item to store
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [short-term, long-term, permanent]
                content:
                  type: string
              required: [type, content]
            examples:
              mem-create:
                value:
                  type: long-term
                  content: "Reminder: buy batteries"
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryItem'
              examples:
                created-memory:
                  value:
                    id: "mem_2"
                    type: long-term
                    content: "Reminder: buy batteries"
                    size_bytes: 23
                    score: 0.0
                    created_at: "2025-11-22T19:20:00Z"
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryItem'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory/{id}:
    delete:
      summary: Delete memory by id
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /agents:
    get:
      summary: List available agents
      security:
        - bearerAuth: []
      responses:
        '200':
          description: agents list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Agent'
              examples:
                agents-sample:
                  value:
                    - id: scheduler
                      name: Scheduler
                      description: Manages calendar and reminders
                      status: idle
                    - id: researcher
                      name: Researcher
                      description: Fetches and summarizes web data
                      status: idle
    post:
      summary: Create/invoke a new agent task
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInvocation'
      requestBody:
        description: Invoke an agent task
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInvocation'
            examples:
              run-research:
                value:
                  task: "search"
                  params:
                    query: "best open-source LLMs"
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTaskResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /agents/{id}/run:
    post:
      summary: Run a specific agent
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInvocation'
      responses:
        '202':
          description: Agent accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTaskResponse'
              examples:
                accepted:
                  value:
                    task_id: "task_123"
                    status: "running"
                    result: {}
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTaskResponse'
        '404':
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

      /memory/query:
        post:
          summary: Semantic+filter query against memory
          security:
            - bearerAuth: []
          requestBody:
            required: true
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/MemoryQueryRequest'
                examples:
                  query-example:
                    value:
                      query: "What are my coffee preferences?"
                      type: any
                      top_k: 3
          responses:
            '200':
              description: Query results
              content:
                application/json:
                  schema:
                    $ref: '#/components/schemas/MemoryQueryResponse'

      /memory/meditate:
        post:
          summary: Trigger a meditation (scoring + pruning) run
          security:
            - bearerAuth: []
          responses:
            '202':
              description: Meditation scheduled
              content:
                application/json:
                  schema:
                    $ref: '#/components/schemas/MeditateResponse'
                  examples:
                    mediate-example:
                      value:
                        status: "scheduled"
                        processed: 0
                        pruned: 0
                        archived: 0

      /memory/metrics:
        get:
          summary: Memory metrics and quotas
          security:
            - bearerAuth: []
          responses:
            '200':
              description: Memory metrics
              content:
                application/json:
                  schema:
                    $ref: '#/components/schemas/MemoryMetrics'
                  examples:
                    metrics-example:
                      value:
                        quota:
                          short_term: 5242880
                          long_term: 26214400
                          permanent: 524288000
                        usage:
                          short_term: 3200000
                          long_term: 8000000
                          permanent: 102400000
                        last_meditation: "2025-11-22T00:00:00Z"

  /errors:
    get:
      summary: List standard errors
      responses:
        '200':
          description: Standard error types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorResponse'
