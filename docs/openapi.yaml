---
openapi: 3.0.3
info:
  title: Kimberly API
  version: 0.1.0
  description: OpenAPI spec for Kimberly personal AI assistant (MVP surface).
servers:
  - url: https://api.kimberly.local/v1
tags:
  - name: Authentication
    description: User authentication and account management
  - name: User
    description: User profile and settings management
  - name: GDPR Compliance
    description: Data privacy and GDPR compliance endpoints
  - name: Chat
    description: Chat messaging with Kimberly
  - name: Memory
    description: Memory management and querying
  - name: Agents
    description: Agent tasks and management
  - name: Billing
    description: Billing and subscription management
  - name: Health
    description: System health and status
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    SignupRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [email, password]
    TokenResponse:
      type: object
      properties:
        token:
          type: string
        expires_in:
          type: integer
          description: seconds until token expires
    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time
    UserSettings:
      type: object
      properties:
        embedding_enabled:
          type: boolean
          description: Whether self-hosted embeddings are enabled
        quotas:
          type: object
          properties:
            short_term:
              type: integer
            long_term:
              type: integer
            permanent:
              type: integer
        consent_telemetry:
          type: boolean
    ExportResponse:
      type: object
      properties:
        export_id:
          type: string
          description: Unique identifier for the export request
        status:
          type: string
          enum: [pending, processing, completed, failed]
          description: Current status of the export
        download_url:
          type: string
          description: URL to download exported data (available when completed)
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          description: When the download URL expires
    ExportStatusResponse:
      type: object
      properties:
        export_id:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        progress_percent:
          type: integer
          minimum: 0
          maximum: 100
        download_url:
          type: string
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        error_message:
          type: string
    DeleteResponse:
      type: object
      properties:
        deletion_id:
          type: string
          description: Unique identifier for the deletion request
        status:
          type: string
          enum: [pending, processing, completed, failed]
        created_at:
          type: string
          format: date-time
    DeleteStatusResponse:
      type: object
      properties:
        deletion_id:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        progress_percent:
          type: integer
          minimum: 0
          maximum: 100
        data_types_deleted:
          type: array
          items:
            type: string
          description: List of data types that have been deleted
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        error_message:
          type: string
    AuditLogEntry:
      type: object
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        user_id:
          type: string
        action:
          type: string
          enum:
            - data_export_requested
            - data_export_completed
            - data_deletion_requested
            - data_deletion_completed
            - consent_updated
            - data_accessed
            - data_modified
            - login
            - logout
            - settings_changed
        resource_type:
          type: string
          description: Type of resource affected
        resource_id:
          type: string
          description: ID of resource affected
        details:
          type: object
          description: Additional context for the action
        ip_address:
          type: string
        user_agent:
          type: string
    AuditLogResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogEntry'
        page:
          type: integer
        per_page:
          type: integer
        total:
          type: integer
    RetentionPolicy:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        data_type:
          type: string
          enum:
            - chat_history
            - memory_short_term
            - memory_long_term
            - memory_permanent
            - audit_logs
            - telemetry
        retention_days:
          type: integer
          description: Number of days to retain data (0 = indefinite)
        auto_delete:
          type: boolean
          description: Whether to automatically delete after retention period
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    RetentionPolicyListResponse:
      type: object
      properties:
        policies:
          type: array
          items:
            $ref: '#/components/schemas/RetentionPolicy'
    ComplianceCheckResult:
      type: object
      properties:
        check_id:
          type: string
        timestamp:
          type: string
          format: date-time
        overall_status:
          type: string
          enum: [compliant, non_compliant, warning]
        checks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              status:
                type: string
                enum: [passed, failed, warning]
              message:
                type: string
              details:
                type: object
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: integer
    ChatMessage:
      type: object
      properties:
        id:
          type: string
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        created_at:
          type: string
          format: date-time
    ChatResponse:
      type: object
      properties:
        conversation_id:
          type: string
        message:
          $ref: '#/components/schemas/ChatMessage'
        usage:
          type: object
          properties:
            prompt_tokens:
              type: integer
            completion_tokens:
              type: integer
            total_tokens:
              type: integer
    MemoryItem:
      type: object
      properties:
        id:
          type: string
        user_id:
          type: string
        type:
          type: string
          enum: [short-term, long-term, permanent]
        content:
          type: string
        size_bytes:
          type: integer
        metadata:
          type: object
          properties:
            tags:
              type: array
              items:
                type: string
            source:
              type: string
              enum: [chat, agent, import, upload]
            channels:
              type: array
              items:
                type: string
            sensitive:
              type: boolean
            scope:
              type: string
              enum: [private, shared, public]
            user_feedback:
              type: string
            version:
              type: string
        score:
          type: number
          format: float
        embedding_ref:
          type: string
        created_at:
          type: string
          format: date-time
        last_seen_at:
          type: string
          format: date-time
        audit:
          type: object
          properties:
            created_by:
              type: string
              enum: [system, user, agent]
            consent:
              type: boolean
    MemoryListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MemoryItem'
        page:
          type: integer
        per_page:
          type: integer
        total:
          type: integer
    Agent:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [idle, running, failed, completed]
        last_run:
          type: string
          format: date-time
    AgentTaskResponse:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
        result:
          type: object
    AgentInvocation:
      type: object
      properties:
        agent_id:
          type: string
          description: >
            Optional ID of the agent to invoke. If not specified, the system
            will automatically route the task to the appropriate agent.
        task:
          type: string
          description: The task to perform
        params:
          type: object
          description: Parameters for the task
      required: [task]
    ChatRequest:
      type: object
      properties:
        message:
          type: string
        context_id:
          type: string
      required: [message]
    MemoryQueryRequest:
      type: object
      properties:
        query:
          type: string
        type:
          type: string
          enum: [short-term, long-term, permanent, any]
        top_k:
          type: integer
          default: 5
        filters:
          type: object
      required: [query]
    MemoryQueryResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/MemoryItem'
    MeditateResponse:
      type: object
      properties:
        status:
          type: string
        processed:
          type: integer
        pruned:
          type: integer
        archived:
          type: integer
    MemoryMetrics:
      type: object
      properties:
        quota:
          type: object
          properties:
            short_term:
              type: integer
            long_term:
              type: integer
            permanent:
              type: integer
        usage:
          type: object
          properties:
            short_term:
              type: integer
            long_term:
              type: integer
            permanent:
              type: integer
        last_meditation:
          type: string
          format: date-time
paths:
  /signup:
    post:
      summary: Create a user account
      description: Register a new user account with email and password
      tags:
        - Authentication
      requestBody:
        description: User sign-up payload
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
            examples:
              signup-example:
                value:
                  email: "alice@example.com"
                  password: "s3curePass!"
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /login:
    post:
      summary: Authenticate user
      description: Authenticate an existing user and receive a JWT token
      tags:
        - Authentication
      requestBody:
        description: User login
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
            examples:
              login-example:
                value:
                  email: "alice@example.com"
                  password: "s3curePass!"
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user:
    get:
      summary: Get user profile and settings
      description: Retrieve the authenticated user's profile and settings
      tags:
        - User
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update user settings
      description: Update the authenticated user's settings and preferences
      tags:
        - User
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSettings'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/export:
    post:
      summary: Export user data (GDPR Article 20 - Data Portability)
      description: >
        Initiates an export of all user data in a portable format (JSON).
        This endpoint complies with GDPR Article 20 (Right to Data Portability).
        The export includes: profile data, memories, chat history, preferences,
        and associated metadata.
      operationId: requestDataExport
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [json, csv]
                  default: json
                  description: Export format
                include_metadata:
                  type: boolean
                  default: true
                  description: Include metadata in export
      responses:
        '202':
          description: Export initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'
              examples:
                export-initiated:
                  value:
                    export_id: "exp_abc123"
                    status: "pending"
                    created_at: "2025-11-26T10:00:00Z"
                    expires_at: "2025-12-03T10:00:00Z"
        '429':
          description: Too many export requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/export/{export_id}:
    get:
      summary: Get export status
      description: Check the status of a data export request
      operationId: getExportStatus
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      parameters:
        - name: export_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Export status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportStatusResponse'
              examples:
                export-completed:
                  value:
                    export_id: "exp_abc123"
                    status: "completed"
                    progress_percent: 100
                    download_url: "https://storage.kimberly.local/exports/..."
                    created_at: "2025-11-26T10:00:00Z"
                    completed_at: "2025-11-26T10:05:00Z"
                    expires_at: "2025-12-03T10:00:00Z"
        '404':
          description: Export not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/delete:
    post:
      summary: Delete user account and data (GDPR Article 17 - Right to Erasure)
      description: >
        Initiates deletion of all user data. This endpoint complies with
        GDPR Article 17 (Right to Erasure / Right to be Forgotten).
        All personal data including profile, memories, chat history, and
        associated metadata will be permanently deleted.
      operationId: requestDataDeletion
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                confirm:
                  type: boolean
                  description: Confirmation that user wants to delete all data
                  default: false
                reason:
                  type: string
                  description: Optional reason for deletion (for analytics)
      responses:
        '202':
          description: Deletion initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
              examples:
                deletion-initiated:
                  value:
                    deletion_id: "del_xyz789"
                    status: "pending"
                    created_at: "2025-11-26T10:00:00Z"
        '400':
          description: Confirmation required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/delete/{deletion_id}:
    get:
      summary: Get deletion status
      description: Check the status of a data deletion request
      operationId: getDeletionStatus
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      parameters:
        - name: deletion_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deletion status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteStatusResponse'
              examples:
                deletion-completed:
                  value:
                    deletion_id: "del_xyz789"
                    status: "completed"
                    progress_percent: 100
                    data_types_deleted:
                      - "profile"
                      - "memories"
                      - "chat_history"
                      - "preferences"
                    created_at: "2025-11-26T10:00:00Z"
                    completed_at: "2025-11-26T10:10:00Z"
        '404':
          description: Deletion request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /audit/logs:
    get:
      summary: Get audit logs
      description: >
        Retrieve audit logs for the authenticated user. Logs include all
        data access, modifications, exports, and deletions for compliance
        tracking.
      operationId: getAuditLogs
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: action
          in: query
          schema:
            type: string
            enum:
              - data_export_requested
              - data_export_completed
              - data_deletion_requested
              - data_deletion_completed
              - consent_updated
              - data_accessed
              - data_modified
              - login
              - logout
              - settings_changed
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Audit logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogResponse'
              examples:
                audit-logs:
                  value:
                    items:
                      - id: "log_001"
                        timestamp: "2025-11-26T10:00:00Z"
                        user_id: "user_123"
                        action: "data_export_requested"
                        resource_type: "user_data"
                        resource_id: "exp_abc123"
                        details:
                          format: "json"
                        ip_address: "192.168.1.1"
                        user_agent: "Mozilla/5.0..."
                    page: 1
                    per_page: 50
                    total: 1
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /compliance/retention-policies:
    get:
      summary: Get retention policies
      description: >
        Retrieve the current data retention policies. Policies define how
        long different types of data are retained before automatic deletion.
      operationId: getRetentionPolicies
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Retention policies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetentionPolicyListResponse'
              examples:
                policies:
                  value:
                    policies:
                      - id: "pol_001"
                        name: "Chat History Retention"
                        data_type: "chat_history"
                        retention_days: 365
                        auto_delete: true
                        created_at: "2025-01-01T00:00:00Z"
                        updated_at: "2025-01-01T00:00:00Z"
                      - id: "pol_002"
                        name: "Short-term Memory Retention"
                        data_type: "memory_short_term"
                        retention_days: 7
                        auto_delete: true
                        created_at: "2025-01-01T00:00:00Z"
                        updated_at: "2025-01-01T00:00:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update retention policies
      description: Update data retention policies for the user
      operationId: updateRetentionPolicies
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                policies:
                  type: array
                  items:
                    type: object
                    properties:
                      data_type:
                        type: string
                        enum:
                          - chat_history
                          - memory_short_term
                          - memory_long_term
                          - memory_permanent
                          - audit_logs
                          - telemetry
                      retention_days:
                        type: integer
                        minimum: 0
                      auto_delete:
                        type: boolean
                    required:
                      - data_type
                      - retention_days
      responses:
        '200':
          description: Policies updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetentionPolicyListResponse'
        '400':
          description: Invalid policy configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /compliance/check:
    get:
      summary: Run compliance check
      description: >
        Run automated compliance checks to verify GDPR and data protection
        requirements are being met. Returns a detailed report of all checks.
      operationId: runComplianceCheck
      tags:
        - GDPR Compliance
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Compliance check results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceCheckResult'
              examples:
                compliant:
                  value:
                    check_id: "chk_001"
                    timestamp: "2025-11-26T10:00:00Z"
                    overall_status: "compliant"
                    checks:
                      - name: "Data Encryption"
                        status: "passed"
                        message: "All data at rest is encrypted"
                      - name: "Retention Policies"
                        status: "passed"
                        message: "Retention policies are properly configured"
                      - name: "Audit Logging"
                        status: "passed"
                        message: "Audit logging is enabled"
                      - name: "Data Export"
                        status: "passed"
                        message: "Data export functionality is available"
                      - name: "Data Deletion"
                        status: "passed"
                        message: "Data deletion functionality is available"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /health:
    get:
      summary: Health check
      description: Check the health status of the API service
      tags:
        - Health
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  uptime_seconds:
                    type: integer
  /chat:
    post:
      summary: Send a chat message to Kimberly
      description: Send a message to Kimberly and receive a response
      tags:
        - Chat
      security:
        - bearerAuth: []
      requestBody:
        description: Chat message
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple-chat:
                value:
                  message: "What's on my schedule today?"
      responses:
        '200':
          description: Chat response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                simple:
                  value:
                    conversation_id: "conv_123"
                    message:
                      id: "msg_456"
                      role: assistant
                      content: "Hello â€” how can I help today?"
                      created_at: "2025-11-22T19:00:00Z"
                    usage:
                      prompt_tokens: 4
                      completion_tokens: 12
                      total_tokens: 16
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory:
    get:
      summary: List memory items
      description: List all memory items for the authenticated user
      tags:
        - Memory
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
        - name: type
          in: query
          schema:
            type: string
            enum: [short-term, long-term, permanent]
        - name: tags
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Memory list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryListResponse'
              examples:
                sample-memory-list:
                  value:
                    items:
                      - id: "mem_1"
                        user_id: "user_123"
                        type: short-term
                        content: "Met Mike at the cafe"
                        size_bytes: 120
                        metadata:
                          tags: ["meeting"]
                          source: "chat"
                          sensitive: false
                        score: 0.8
                        created_at: "2025-11-22T10:00:00Z"
                        last_seen_at: "2025-11-22T10:30:00Z"
                        audit:
                          created_by: "user"
                          consent: true
                    page: 1
                    per_page: 20
                    total: 1
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Add a memory item
      description: Store a new memory item for the authenticated user
      tags:
        - Memory
      security:
        - bearerAuth: []
      requestBody:
        description: Memory item to store
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [short-term, long-term, permanent]
                content:
                  type: string
                metadata:
                  $ref: '#/components/schemas/MemoryItem/properties/metadata'
              required: [type, content]
            examples:
              mem-create:
                value:
                  type: long-term
                  content: "Reminder: buy batteries"
                  metadata:
                    tags: ["reminder"]
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryItem'
              examples:
                created-memory:
                  value:
                    id: "mem_2"
                    user_id: "user_123"
                    type: long-term
                    content: "Reminder: buy batteries"
                    size_bytes: 23
                    metadata:
                      tags: ["reminder"]
                    score: 0.0
                    created_at: "2025-11-22T19:20:00Z"
                    last_seen_at: "2025-11-22T19:20:00Z"
                    audit:
                      created_by: "user"
                      consent: true
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory/{id}:
    delete:
      summary: Delete memory by id
      description: Delete a specific memory item by its ID
      tags:
        - Memory
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory/query:
    post:
      summary: Semantic+filter query against memory
      description: >
        Perform a semantic search query against the memory store with
        optional filters
      tags:
        - Memory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MemoryQueryRequest'
            examples:
              query-example:
                value:
                  query: "What are my coffee preferences?"
                  type: any
                  top_k: 3
      responses:
        '200':
          description: Query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryQueryResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory/meditate:
    post:
      summary: Trigger a meditation (scoring + pruning) run
      description: >
        Initiate a meditation process that scores and prunes memory items
        based on usage and relevance
      tags:
        - Memory
      security:
        - bearerAuth: []
      responses:
        '202':
          description: Meditation scheduled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeditateResponse'
              examples:
                mediate-example:
                  value:
                    status: "scheduled"
                    processed: 0
                    pruned: 0
                    archived: 0
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory/embed:
    post:
      summary: Upload self-hosted embeddings (optional, free-mode only)
      description: >
        Upload custom embeddings for memory items when using self-hosted
        embedding models (free mode only)
      tags:
        - Memory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                embeddings:
                  type: array
                  items:
                    type: object
                    properties:
                      memory_id:
                        type: string
                      embedding:
                        type: array
                        items:
                          type: number
                          format: float
                    required: [memory_id, embedding]
              required: [embeddings]
      responses:
        '200':
          description: Embeddings uploaded
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /memory/metrics:
    get:
      summary: Get memory usage metrics
      description: >
        Retrieve memory quota and usage metrics for the authenticated user,
        including storage usage across all memory types
      tags:
        - Memory
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Memory metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryMetrics'
              examples:
                memory-metrics:
                  value:
                    quota:
                      short_term: 1000
                      long_term: 5000
                      permanent: 100
                    usage:
                      short_term: 234
                      long_term: 1520
                      permanent: 12
                    last_meditation: "2025-11-22T15:00:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /agents:
    get:
      summary: List available agents
      description: Get a list of all available agents and their current status
      tags:
        - Agents
      security:
        - bearerAuth: []
      responses:
        '200':
          description: agents list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Agent'
              examples:
                agents-sample:
                  value:
                    - id: scheduler
                      name: Scheduler
                      description: Manages calendar and reminders
                      status: idle
                    - id: researcher
                      name: Researcher
                      description: Fetches and summarizes web data
                      status: idle
                    - id: coder
                      name: Coder
                      description: Assists with coding, debugging, automation
                      status: idle
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Create/invoke a new agent task
      description: Invoke an agent to perform a task asynchronously
      tags:
        - Agents
      security:
        - bearerAuth: []
      requestBody:
        description: Invoke an agent task
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInvocation'
            examples:
              run-research:
                value:
                  task: "search"
                  params:
                    query: "best open-source LLMs"
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTaskResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /agents/tasks/{task_id}:
    get:
      summary: Get status of an agent task
      description: Check the current status and result of an agent task
      tags:
        - Agents
      security:
        - bearerAuth: []
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentTaskResponse'
        '404':
          description: Task not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /billing/subscribe:
    post:
      summary: Subscribe to a billing plan (future feature, currently free)
      description: >
        Subscribe to a billing plan. Currently only free tier is available.
        Premium features will be added in future releases.
      tags:
        - Billing
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                plan:
                  type: string
                  enum: [free, premium]
              required: [plan]
      responses:
        '202':
          description: Subscription initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
