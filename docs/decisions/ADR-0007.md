# ADR-0007: PostgreSQL + pgvector Database Architecture

## Status

Accepted

## Context

Kimberly requires a database solution that supports both relational data (users, conversations, metadata) and vector embeddings for semantic memory search. The system must balance performance, cost, and operational complexity while maintaining free-mode compatibility.

## Decision

Implement PostgreSQL with pgvector extension as the primary database solution:

**Core Database:** PostgreSQL with pgvector extension

- Handles all relational data (users, conversations, memory metadata)
- Provides vector similarity search for memory retrieval
- Single database solution reduces operational complexity
- Free and open-source, aligns with project cost goals

**Migration Path:** Planned upgrade path to dedicated vector database if needed

- Monitor performance metrics and query latency
- Thresholds for migration: >500ms average vector search latency, >10M vectors stored
- Target alternatives: Pinecone (managed) or Weaviate (self-hosted) based on cost/performance analysis

## Consequences

- **Pros:** Simplified architecture, single database to manage, proven pgvector performance, cost-effective
- **Cons:** Potential performance limitations at scale, PostgreSQL operational overhead
- **Risks:** Vector search performance may degrade with large datasets, migration complexity
- **Benefits:** Aligns with free-mode goals, reduces infrastructure complexity, enables rapid prototyping

## Implementation Notes

- Use pgvector for cosine similarity searches on memory embeddings
- Implement proper indexing strategies (IVFFlat, HNSW) for performance
- Plan for horizontal scaling via read replicas if needed
- Monitor vector search latency and accuracy metrics
- Design schema to support potential future migration

## Migration Triggers

- Average vector search latency >500ms (p95)
- Total vectors stored >10M
- Memory retrieval accuracy degradation >5%
- PostgreSQL resource utilization >80% sustained
